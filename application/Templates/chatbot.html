<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>AI Chat Assistant</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>

  <style>
    :root{
      --primary:#3b82f6;        /* blue-500 */
      --primary-600:#2563eb;    /* blue-600 */
      --surface:#ffffff;
      --bg:#f1f5f9;            /* slate-100 */
      --text:#0f172a;          /* slate-900 */
      --muted:#64748b;         /* slate-500 */
      --line:#e2e8f0;          /* slate-200 */
      --user:#e0e7ff;          /* indigo-100 */
      --bot:#f8fafc;           /* slate-50  */
      --shadow:0 10px 25px rgba(0,0,0,.08);
    }

    *{box-sizing:border-box;font-family:Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial}
    html,body{height:100%}
    body{
      margin:0; background:linear-gradient(180deg, #f8fafc 0%, #eef2f7 100%);
      display:grid; place-items:center; color:var(--text);
    }

    .chat-wrap{
      width:min(980px, 96vw);
      display:grid;
      grid-template-columns: 360px 1fr;
      gap:18px;
      padding:18px;
    }
    @media (max-width: 900px){
      .chat-wrap{ grid-template-columns: 1fr; padding:12px; }
    }

    .profile-card{
      background:var(--surface); border:1px solid var(--line); border-radius:16px; box-shadow:var(--shadow);
      padding:18px; display:flex; flex-direction:column; gap:14px; min-height:160px;
    }
    .profile-row{display:flex; align-items:center; gap:12px}
    .avatar{
      width:44px; height:44px; border-radius:50%; display:grid; place-items:center;
      background:linear-gradient(145deg,#e0e7ff,#f5f7ff); color:#3730a3; font-weight:700;
      border:1px solid #e5e7eb;
    }
    .status-dot{width:10px; height:10px; border-radius:999px; background:#10b981; box-shadow:0 0 0 2px #ecfdf5}
    .divider{height:1px; background:var(--line); margin:2px 0}

    .chat-container{
      background:var(--surface); border:1px solid var(--line); border-radius:16px; box-shadow:var(--shadow);
      display:flex; flex-direction:column; height:min(86vh, 860px); overflow:hidden;
    }

    .chat-header{
      background:linear-gradient(135deg, var(--primary) 0%, var(--primary-600) 100%);
      color:#fff; padding:14px 16px; display:flex; align-items:center; justify-content:space-between;
    }
    .chat-title{display:flex; align-items:center; gap:10px; font-weight:700}
    .chat-title i{opacity:.9}

    .exit-btn{
      background:rgba(255,255,255,.18); color:#fff; border:0; padding:8px 12px; border-radius:24px; cursor:pointer;
      display:flex; align-items:center; gap:8px; transition:all .2s ease;
    }
    .exit-btn:hover{ background:rgba(255,255,255,.28); transform:translateY(-1px) }

    .chat-messages{
      flex:1; padding:18px; overflow-y:auto; display:flex; flex-direction:column; gap:12px; background:#fff;
    }
    .message{
      max-width:78%; padding:10px 14px; border-radius:14px; font-size:14px; line-height:1.45; position:relative;
      animation:fade-in .18s ease-out;
      box-shadow:0 2px 6px rgba(0,0,0,.03);
    }
    .message.user{ align-self:flex-end; background:var(--user); border:1px solid #c7d2fe; }
    .message.bot{ align-self:flex-start; background:var(--bot); border:1px solid var(--line); }
    .time{
      margin-top:4px; font-size:11px; color:var(--muted); text-align:right;
    }
    @keyframes fade-in{from{opacity:0; transform:translateY(8px)} to{opacity:1; transform:translateY(0)}}

    .typing{ display:inline-flex; gap:4px; padding:10px 14px; border-radius:12px; background:var(--bot); border:1px solid var(--line); align-self:flex-start }
    .dot{ width:6px; height:6px; border-radius:50%; background:#94a3b8; animation:blink 1s infinite ease-in-out }
    .dot:nth-child(2){animation-delay:.15s}
    .dot:nth-child(3){animation-delay:.3s}
    @keyframes blink{0%,100%{transform:translateY(0)} 50%{transform:translateY(-4px)}}

    .input-area{
      border-top:1px solid var(--line); padding:12px; display:flex; gap:8px; background:#fff;
    }
    .input{
      flex:1; padding:12px 14px; border:1px solid var(--line); border-radius:12px; font-size:14px; outline:0;
      transition:border-color .15s ease, box-shadow .15s ease;
    }
    .input:focus{ border-color:var(--primary); box-shadow:0 0 0 3px rgba(59,130,246,.15) }
    .send{
      width:44px; height:44px; border-radius:12px; border:0; background:var(--primary); color:#fff; cursor:pointer;
      display:grid; place-items:center; transition:transform .15s ease, background .15s ease;
    }
    .send:disabled{ background:#cbd5e1; cursor:not-allowed }
    .send:hover:not(:disabled){ background:var(--primary-600); transform:translateY(-1px) }

    /* scrollbar */
    .chat-messages::-webkit-scrollbar{ width:8px }
    .chat-messages::-webkit-scrollbar-thumb{ background:#cbd5e1; border-radius:6px }
    .chat-messages::-webkit-scrollbar-track{ background:#f8fafc }

    /* Exit confirm modal */
    .modal{
      position:fixed; inset:0; background:rgba(15,23,42,.5); display:none; align-items:center; justify-content:center; padding:16px; z-index:50;
    }
    .modal.show{ display:flex }
    .modal-card{
      width:min(440px, 92vw); background:#fff; border:1px solid var(--line); border-radius:16px; box-shadow:0 20px 60px rgba(0,0,0,.25);
      overflow:hidden; animation:pop .18s ease-out;
    }
    @keyframes pop{ from{ opacity:0; transform:translateY(10px) scale(.98)} to{ opacity:1; transform:translateY(0) scale(1)} }
    .modal-hd{ display:flex; align-items:center; justify-content:space-between; padding:14px 16px; border-bottom:1px solid var(--line) }
    .modal-ttl{ font-weight:700 }
    .modal-bd{ padding:14px 16px; color:var(--muted) }
    .modal-ft{ padding:14px 16px; display:flex; justify-content:flex-end; gap:8px; background:#fafafa; border-top:1px solid var(--line) }
    .btn{ padding:10px 14px; border-radius:10px; border:1px solid var(--line); background:#fff; cursor:pointer }
    .btn-danger{ background:#ef4444; color:#fff; border-color:#ef4444 }
    .btn-danger:hover{ background:#dc2626; border-color:#dc2626 }
    .btn-ghost:hover{ background:#f3f4f6 }
    .close-x{ border:0; background:transparent; color:#ef4444; font-size:18px; cursor:pointer }
    .close-x:hover{ color:#dc2626 }
  </style>
</head>
<body>

  <div class="chat-wrap">
    <!-- Left: mini profile / helper panel -->
    <aside class="profile-card">
      <div class="profile-row">
        <div class="avatar"><i class="fa-solid fa-robot"></i></div>
        <div>
          <div style="font-weight:700">AI Assistant</div>
          <div style="display:flex; align-items:center; gap:6px; font-size:12px; color:var(--muted)">
            <span class="status-dot"></span> Online
          </div>
        </div>
      </div>
      <div class="divider"></div>
      <div style="font-size:13px; color:var(--muted); line-height:1.5">
        Ask me about job posts, your applications, resumes, or company questions. I’ll keep it short & useful.
      </div>
    </aside>

    <!-- Right: chat -->
    <section class="chat-container">
      <header class="chat-header">
        <div class="chat-title"><i class="fa-solid fa-comments"></i> <span>Chat</span></div>
        <button id="exit-chat" class="exit-btn"><i class="fa-solid fa-right-from-bracket"></i> Exit</button>
      </header>

      <div id="chat-messages" class="chat-messages"></div>

      <footer class="input-area">
        <input id="message-input" class="input" type="text" placeholder="Type a message…"/>
        <button id="send-btn" class="send" disabled><i class="fa-solid fa-paper-plane"></i></button>
      </footer>
    </section>
  </div>

  <!-- Exit Confirmation Modal -->
  <div id="exitModal" class="modal" aria-hidden="true">
    <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="exitTitle">
      <div class="modal-hd">
        <div id="exitTitle" class="modal-ttl">Leave chat?</div>
        <button class="close-x" id="exitClose" aria-label="Close">✕</button>
      </div>
      <div class="modal-bd">
        You’re about to exit the AI chat. Any unsent message will be lost. Are you sure you want to continue?
      </div>
      <div class="modal-ft">
        <button class="btn btn-ghost" id="cancelExit">Cancel</button>
        <button class="btn btn-danger" id="confirmExit">Yes, Exit</button>
      </div>
    </div>
  </div>

  <script>
    const userRole = "{{ current_user.role if current_user else '' }}";

    // Elements
    const chatMessages = document.getElementById('chat-messages');
    const messageInput = document.getElementById('message-input');
    const sendBtn = document.getElementById('send-btn');
    const exitBtn = document.getElementById('exit-chat');

    // Modal elements
    const exitModal = document.getElementById('exitModal');
    const exitClose = document.getElementById('exitClose');
    const cancelExit = document.getElementById('cancelExit');
    const confirmExit = document.getElementById('confirmExit');

    // Initial greeting
    setTimeout(()=> addMessage("Hello! How can I assist you today?", "bot"), 400);

    messageInput.addEventListener('input', ()=> {
      sendBtn.disabled = messageInput.value.trim() === '';
    });

    messageInput.addEventListener('keydown', (e)=>{
      if(e.key === 'Enter' && !e.shiftKey){
        e.preventDefault();
        if(!sendBtn.disabled) sendMessage();
      }
    });
    sendBtn.addEventListener('click', sendMessage);

    // Exit
    exitBtn.addEventListener('click', openExitConfirm);
    exitClose.addEventListener('click', closeExitConfirm);
    cancelExit.addEventListener('click', closeExitConfirm);
    document.addEventListener('keydown', (e)=> { if(e.key === 'Escape') closeExitConfirm(); });

    confirmExit.addEventListener('click', ()=>{
      if (userRole === 'company') {
        window.location.href = '/company_dashboard';
      } else if (userRole === 'seeker') {
        window.location.href = '/seeker_dashboard';
      } else {
        window.location.href = '/';
      }
    });

    function openExitConfirm(){
      exitModal.classList.add('show');
      exitModal.setAttribute('aria-hidden','false');
    }
    function closeExitConfirm(){
      exitModal.classList.remove('show');
      exitModal.setAttribute('aria-hidden','true');
    }

    // Chat helpers
    function addMessage(text, who){
      const msg = document.createElement('div');
      msg.className = `message ${who}`;
      const time = new Date().toLocaleTimeString([], { hour:'2-digit', minute:'2-digit' });
      msg.innerHTML = `${sanitize(text)}<div class="time">${time}</div>`;
      chatMessages.appendChild(msg);
      scrollToBottom();
    }

    function showTyping(){
      const tip = document.createElement('div');
      tip.className = 'typing';
      tip.id = 'typing';
      tip.innerHTML = '<div class="dot"></div><div class="dot"></div><div class="dot"></div>';
      chatMessages.appendChild(tip);
      scrollToBottom();
    }
    function hideTyping(){
      const t = document.getElementById('typing');
      if(t) t.remove();
    }
    function scrollToBottom(){ chatMessages.scrollTop = chatMessages.scrollHeight; }

    // Send to Flask backend
    function sendMessage(){
      const message = messageInput.value.trim();
      if(!message) return;
      addMessage(message, 'user');
      messageInput.value = '';
      sendBtn.disabled = true;

      showTyping();
      fetch('/chat', {
        method:'POST',
        headers:{ 'Content-Type':'application/x-www-form-urlencoded' },
        body:'message=' + encodeURIComponent(message)
      })
      .then(r=> { if(!r.ok) throw new Error('Network error'); return r.json(); })
      .then(data=>{
        hideTyping();
        addMessage(data?.response || "I didn't get a response. Please try again.", 'bot');
      })
      .catch(err=>{
        hideTyping();
        console.error(err);
        addMessage("Sorry, there was an error processing your request.", 'bot');
      });
    }

    function sanitize(s){
      return String(s)
        .replaceAll('&','&amp;')
        .replaceAll('<','&lt;')
        .replaceAll('>','&gt;');
    }

    // focus input on load
    messageInput.focus();
  </script>
</body>
</html>
